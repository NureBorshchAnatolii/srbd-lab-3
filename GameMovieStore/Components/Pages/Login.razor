@page "/login"
@using System.ComponentModel.DataAnnotations
@using GameMovieStore.Contracts.Services
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IHttpContextAccessor Http

<h3>Login</h3>

<EditForm Model="Model" OnSubmit="Submit" FormName="login-form">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div>
        <label>Username: <InputText @bind-Value="Model!.Username"/></label>
    </div>
    <div>
        <label>Password: <InputText type="password" @bind-Value="Model!.Password"/></label>
    </div>
    <div>
        <button type="submit">Login</button>
    </div>
</EditForm>

<p style="color:red">@_errorMessage</p>

@code {
    [SupplyParameterFromForm]
    private LoginModel? Model { get; set; }

    private string _errorMessage = "";

    protected override void OnInitialized() => Model ??= new();

    private async Task Submit()
    {
        try
        {
            await AuthService.LoginAsync(
                Model!.Username,
                Model!.Password
            );

            Http.HttpContext!.Response.Redirect("/");
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
    }

    public class LoginModel
    {
        [Required(ErrorMessage = "Username is required")]
        [MinLength(3, ErrorMessage = "Username must be at least 3 chars")]
        public string Username { get; set; } = "";

        [Required(ErrorMessage = "Password is required")]
        [MinLength(6, ErrorMessage = "Password must be at least 6 chars")]
        public string Password { get; set; } = "";
    }
}
